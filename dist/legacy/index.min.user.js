// ==UserScript==
// @name           Tag Creation Request Completer
// @author         Oleg Valter <oleg.a.valter@gmail.com>
// @description    Updates tag creation request posts to indicate their completion/decline status and properly tags/edits them
// @grant          none
// @homepage       https://github.com/userscripters/tag-creation-request-completer#readme
// @match          https://stackoverflow.com/questions/*
// @match          https://serverfault.com/questions/*
// @match          https://superuser.com/questions/*
// @match          https://*.stackexchange.com/questions/*
// @match          https://askubuntu.com/questions/*
// @match          https://stackapps.com/questions/*
// @match          https://mathoverflow.net/questions/*
// @match          https://pt.stackoverflow.com/questions/*
// @match          https://ja.stackoverflow.com/questions/*
// @match          https://ru.stackoverflow.com/questions/*
// @match          https://es.stackoverflow.com/questions/*
// @match          https://meta.stackoverflow.com/questions/*
// @match          https://meta.serverfault.com/questions/*
// @match          https://meta.superuser.com/questions/*
// @match          https://meta.askubuntu.com/questions/*
// @match          https://meta.mathoverflow.net/questions/*
// @match          https://pt.meta.stackoverflow.com/questions/*
// @match          https://ja.meta.stackoverflow.com/questions/*
// @match          https://ru.meta.stackoverflow.com/questions/*
// @match          https://es.meta.stackoverflow.com/questions/*
// @namespace      userscripters
// @run-at         document-start
// @source         git+https://github.com/userscripters/tag-creation-request-completer.git
// @supportURL     https://github.com/userscripters/tag-creation-request-completer/issues
// @version        0.1.0
// ==/UserScript==

"use strict";var __awaiter=this&&this.__awaiter||function(e,s,i,c){return new(i=i||Promise)(function(n,t){function a(e){try{r(c.next(e))}catch(e){t(e)}}function o(e){try{r(c.throw(e))}catch(e){t(e)}}function r(e){var t;e.done?n(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(a,o)}r((c=c.apply(e,s||[])).next())})},__generator=this&&this.__generator||function(a,o){var r,s,i,c={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(n){return function(e){var t=[n,e];if(r)throw new TypeError("Generator is already executing.");for(;c;)try{if(r=1,s&&(i=2&t[0]?s.return:t[0]?s.throw||((i=s.return)&&i.call(s),0):s.next)&&!(i=i.call(s,t[1])).done)return i;switch(s=0,(t=i?[2&t[0],i.value]:t)[0]){case 0:case 1:i=t;break;case 4:return c.label++,{value:t[1],done:!1};case 5:c.label++,s=t[1],t=[0];continue;case 7:t=c.ops.pop(),c.trys.pop();continue;default:if(!(i=0<(i=c.trys).length&&i[i.length-1])&&(6===t[0]||2===t[0])){c=0;continue}if(3===t[0]&&(!i||t[1]>i[0]&&t[1]<i[3]))c.label=t[1];else if(6===t[0]&&c.label<i[1])c.label=i[1],i=t;else{if(!(i&&c.label<i[2])){i[2]&&c.ops.pop(),c.trys.pop();continue}c.label=i[2],c.ops.push(t)}}t=o.call(a,c)}catch(e){t=[6,e],s=0}finally{r=i=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},__read=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var a,o,r=n.call(e),s=[];try{for(;(void 0===t||0<t--)&&!(a=r.next()).done;)s.push(a.value)}catch(e){o={error:e}}finally{try{a&&!a.done&&(n=r.return)&&n.call(r)}finally{if(o)throw o.error}}return s},__spreadArray=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var a,o=0,r=t.length;o<r;o++)!a&&o in t||((a=a||Array.prototype.slice.call(t,0,o))[o]=t[o]);return e.concat(a||Array.prototype.slice.call(t))},__values=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],a=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return{value:(e=e&&a>=e.length?void 0:e)&&e[a++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},API_BASE="https://api.stackexchange.com",API_KEY="vwe8m0x2S01He9D)WRCGPQ((",API_VER="2.3",wait=function(t){return new Promise(function(e){return setTimeout(e,t)})},getPaginatedItems=function(i,c){return __awaiter(void 0,void 0,void 0,function(){var t,n,a,o,r,s;return __generator(this,function(e){switch(e.label){case 0:return i.searchParams.set("page",c.toString()),[4,fetch(i)];case 1:return(t=e.sent()).ok?[4,t.json()]:[2,[]];case 2:return(t=e.sent(),n=t.items,a=t.has_more,o=t.backoff)?[4,wait(1e3*o)]:[3,4];case 3:return e.sent(),[2,getPaginatedItems(i,c)];case 4:return a?(s=[__spreadArray([],__read(n),!1)],[4,getPaginatedItems(i,c+1)]):[3,6];case 5:return r=__spreadArray.apply(void 0,s.concat([__read.apply(void 0,[e.sent()]),!1])),[3,7];case 6:r=n,e.label=7;case 7:return[2,r]}})})},getTags=function(r,s){return __awaiter(void 0,void 0,void 0,function(){var t,n,a,o;return __generator(this,function(e){return r.length?(t=s.page,t=void 0===t?1:t,a=s.filter,a=void 0===a?"default":a,o=s.key,n=s.site,a=new URLSearchParams({filter:a,key:o,pagesize:"100",site:void 0===n?"stackoverflow":n}),(o=new URL("".concat(API_BASE,"/").concat(API_VER,"/tags/").concat(r.join(";"),"/info"))).search=a.toString(),[2,getPaginatedItems(o,t)]):[2,[]]})})},getQuestions=function(r,s){return __awaiter(void 0,void 0,void 0,function(){var t,n,a,o;return __generator(this,function(e){return r.length?(t=s.page,t=void 0===t?1:t,a=s.filter,a=void 0===a?"default":a,o=s.key,n=s.site,a=new URLSearchParams({filter:a,key:o,pagesize:"100",site:void 0===n?"stackoverflow":n}),(o=new URL("".concat(API_BASE,"/").concat(API_VER,"/questions/").concat(r.join(";")))).search=a.toString(),[2,getPaginatedItems(o,t)]):[2,[]]})})},getAPIsite=function(){var e=location.hostname;return e.substring(0,e.lastIndexOf("."))},getPostGuid=function(r,s,i){return __awaiter(void 0,void 0,void 0,function(){var t,n,a,o;return __generator(this,function(e){switch(e.label){case 0:return t=new URL("".concat(s,"/posts/").concat(i,"/edit-inline")),[4,fetch(t)];case 1:return(t=e.sent()).ok?(n=document.createElement("html"),a=n,[4,t.text()]):(console.debug("[".concat(r,"] failed to get post #").concat(i," GUID")),[2]);case 2:return(a.innerHTML=e.sent(),o=n.querySelector("form.inline-post"))?[2,o.action.replace("".concat(s,"/posts/").concat(i,"/edit-submit/"),"")]:(console.debug("[".concat(r,"] failed to parse post #").concat(i," GUID")),[2])}})})},submitEdit=function(c,u){return __awaiter(void 0,void 0,void 0,function(){var t,n,a,o,r,s,i;return __generator(this,function(e){switch(e.label){case 0:t=u.origin,n=u.postId,a=u.postGuid,o=u.comment,r=u.title,s=u.body,i=u.tags,e.label=1;case 1:return e.trys.push([1,3,,4]),[4,fetch("".concat(t,"/posts/").concat(n,"/edit-submit/").concat(a),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({"edit-comment":o,fkey:StackExchange.options.user.fkey,"is-current":"true","post-text":s,tagnames:i.join(" "),title:r})})];case 2:return[2,200===e.sent().status];case 3:return e.sent(),console.debug("[".concat(c,"] failed to submit post #").concat(n," edit")),[2,!1];case 4:return[2]}})})},sameTags=function(e,t){return e.length===t.size&&e.every(function(e){return t.has(e)})},copyToClipboard=function(a,o){return __awaiter(void 0,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),t="text/plain",[4,navigator.clipboard.write([new ClipboardItem(((n={})[t]=new Blob([o],{type:t}),n))])];case 1:return e.sent(),[2,!0];case 2:return t=e.sent(),console.debug("[".concat(a,"] failed to copy to clipboard"),t),[2,!1];case 3:return[2]}})})},findRequestedTag=function(e,t){var e=__read(/[\[`“]([\w.-]+)[\]`”]|tags?\s+for\s+["“]([\w.\s-]+)["`”]|(?:create|add|new)(?:\s+(?:a|the))?\s+tags?.+?[\[`"“]([\w.\s-]+)[\]`"”]/i.exec(e)||[]),n=e[1],e=e.slice(2).find(Boolean),t=__read(/[\[`“](\w.-]+)[\]`”]/g.exec(t||"")||[],2)[1];return null==(n=n||t||(null==e?void 0:e.replace(/\s+/g,"-")))?void 0:n.toLowerCase()},fixRequestTitle=function(e,t){return t?e.replace(/[\[`][\w.-]+[\]`]/i,"[".concat(t,"]")):e},scase=function(e){return e.slice(0,1).toUpperCase()+e.slice(1).toLowerCase()},handleFailureToGetPostFromAPI=function(e,t){return console.debug("[".concat(e,"] failed to get post #").concat(t," from the API")),StackExchange.helpers.showToast("Failed to get post info from the API",{type:"danger"})},normalizeDatasetPropName=function(e){return e.split("-").map(function(e,t){var e=__read(e),n=e[0],e=e.slice(1);return"".concat(t?n.toUpperCase():n.toLowerCase()).concat(e.join("").toLowerCase())}).join("")},makeRequestStatusButton=function(p,f,h){var e=document.createElement("div"),t=(e.classList.add("flex--item"),document.createElement("button"));return t.classList.add("s-btn","s-btn__link"),t.dataset[normalizeDatasetPropName("".concat(p,"-btn"))]=f,t.textContent=scase(f),t.title="".concat(scase(f)," the tag creation request"),t.type="button",t.addEventListener("click",function(){return __awaiter(void 0,void 0,void 0,function(){var t,n,a,o,r,s,i,c,u,l,d;return __generator(this,function(e){switch(e.label){case 0:return[4,getQuestions([h],{filter:"7W_5I-T9o",key:API_KEY,site:getAPIsite()})];case 1:return(c=__read.apply(void 0,[e.sent(),1]),c=c[0])?(t=c.body_markdown,n=c.link,l=c.tags,l=void 0===l?[]:l,a=c.title,t&&a?(o=new Set(l),StackExchange.options.user.isModerator&&o.add("status-".concat(f,"d")),o.has("support")||o.has("discussion")||o.add("discussion"),o.delete("tag-creation-process"),o.delete("feature-request"),o.add("tags"),o.add("tag-creation-request"),5<o.size?(console.debug("[".concat(p,"] updated post has too many tags")),[2,StackExchange.helpers.showToast("Posts can't have more than ".concat(5," tag").concat("s"),{type:"warning"})]):(r=[],sameTags(l,o)||r.push("retagged correctly"),s=location.origin,[4,getPostGuid(p,s,h)])):(console.debug("[".concat(p,"] missing post #").concat(h," body/title")),[2,StackExchange.helpers.showToast("Failed to get question body or title from the API",{type:"danger"})])):[2,handleFailureToGetPostFromAPI(p,h)];case 2:return(i=e.sent())?(c=findRequestedTag(a,t),(u=fixRequestTitle(a,c))!==a&&r.push("highlighted the tag in the title"),l="[tag:".concat(c||"","] ").concat(f," ([").concat(u.replace(/(\[|\])/g,"\\$1"),"](").concat(n,"))"),[4,copyToClipboard(p,l)]):(console.debug("[".concat(p,"] failed to get post #").concat(h," GUID")),[2,StackExchange.helpers.showToast("Failed to get the post GUID",{type:"danger"})]);case 3:return(e.sent(),StackExchange.helpers.showToast("Copied chat link to clipboard",{type:"info"}),r.length)?[4,submitEdit(p,{body:t,comment:r.join("; "),origin:s,postGuid:i,postId:h,tags:__spreadArray([],__read(o),!1),title:u})]:(console.debug("[".concat(p,"] nothing to update in the post #").concat(h)),[2,StackExchange.helpers.showToast("Nothing would be updated in the post, aborting edit",{type:"info"})]);case 4:return(d=e.sent(),StackExchange.helpers.showToast(d?"".concat(scase(f),"d the request"):"Failed to ".concat(f," the request"),{type:d?"success":"danger"}),d)?[4,wait(1e3)]:[3,6];case 5:e.sent(),location.reload(),e.label=6;case 6:return[2]}})})}),e.append(t),[e,t]},addScriptStyles=function(e){var t=document.createElement("style"),n=(document.head.append(t),t.sheet);n?[".s-btn[disabled][data-".concat(e,"-btn] {\n            pointer-events: unset;\n        }")].forEach(function(e){return n.insertRule(e)}):console.debug("[".concat(e,"] failed to add userscript styles"))};window.addEventListener("load",function(){return __awaiter(void 0,void 0,void 0,function(){var t,n,a,o,r,s,i,c,u,l,d,p,f,h,g;return __generator(this,function(e){switch(e.label){case 0:n=".js-question .js-post-menu > div:first-child",addScriptStyles(t="tag-creation-request-completer"),e.label=1;case 1:e.trys.push([1,8,9,10]),a=__values(document.querySelectorAll(n)),o=a.next(),e.label=2;case 2:return o.done?[3,7]:(r=o.value,(g=((null==(g=r.closest(".js-post-menu"))?void 0:g.dataset)||{}).postId)?(s=getAPIsite(),[4,getQuestions([g],{filter:"7W_5I-T9o",key:API_KEY,site:s})]):(console.debug("[".concat(t,"] missing question id"),r),[2]));case 3:return(p=__read.apply(void 0,[e.sent(),1]),(p=p[0])||handleFailureToGetPostFromAPI(t,g),c=__read(makeRequestStatusButton(t,"complete",g),2),i=c[0],c=c[1],l=__read(makeRequestStatusButton(t,"decline",g),2),u=l[0],l=l[1],p)?(d=p.body_markdown,p=p.title,p=findRequestedTag(p,d),console.debug("[".concat(t,"] request tag name: ").concat(p||"not found")),p?[4,getTags([p],{key:API_KEY,site:s.replace("meta.","")})]:[3,5]):[3,5];case 4:d=e.sent().length,(p=d?l:c).disabled=!0,p.title+=" (requested tag ".concat(d?"":"not ","found)"),e.label=5;case 5:r.append(i,u),e.label=6;case 6:return o=a.next(),[3,2];case 7:return[3,10];case 8:return f=e.sent(),f={error:f},[3,10];case 9:try{o&&!o.done&&(h=a.return)&&h.call(a)}finally{if(f)throw f.error}return[7];case 10:return[2]}})})},{once:!0});