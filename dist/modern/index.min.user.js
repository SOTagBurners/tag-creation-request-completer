// ==UserScript==
// @name           Tag Creation Request Completer
// @author         Oleg Valter <oleg.a.valter@gmail.com>
// @description    Updates tag creation request posts to indicate their completion/decline status and properly tags/edits them
// @grant          none
// @homepage       https://github.com/userscripters/tag-creation-request-completer#readme
// @match          https://stackoverflow.com/questions/*
// @match          https://serverfault.com/questions/*
// @match          https://superuser.com/questions/*
// @match          https://*.stackexchange.com/questions/*
// @match          https://askubuntu.com/questions/*
// @match          https://stackapps.com/questions/*
// @match          https://mathoverflow.net/questions/*
// @match          https://pt.stackoverflow.com/questions/*
// @match          https://ja.stackoverflow.com/questions/*
// @match          https://ru.stackoverflow.com/questions/*
// @match          https://es.stackoverflow.com/questions/*
// @match          https://meta.stackoverflow.com/questions/*
// @match          https://meta.serverfault.com/questions/*
// @match          https://meta.superuser.com/questions/*
// @match          https://meta.askubuntu.com/questions/*
// @match          https://meta.mathoverflow.net/questions/*
// @match          https://pt.meta.stackoverflow.com/questions/*
// @match          https://ja.meta.stackoverflow.com/questions/*
// @match          https://ru.meta.stackoverflow.com/questions/*
// @match          https://es.meta.stackoverflow.com/questions/*
// @namespace      userscripters
// @run-at         document-start
// @source         git+https://github.com/userscripters/tag-creation-request-completer.git
// @supportURL     https://github.com/userscripters/tag-creation-request-completer/issues
// @version        0.1.0
// ==/UserScript==

"use strict";const API_BASE="https://api.stackexchange.com",API_KEY="vwe8m0x2S01He9D)WRCGPQ((",API_VER="2.3",wait=t=>new Promise(e=>setTimeout(e,t)),getPaginatedItems=async(e,t)=>{e.searchParams.set("page",t.toString());const a=await fetch(e);var s,o,n;return a.ok?({items:s,has_more:o,backoff:n}=await a.json(),n?(await wait(1e3*n),getPaginatedItems(e,t)):o?[...s,...await getPaginatedItems(e,t+1)]:s):[]},getTags=async(e,t)=>{if(!e.length)return[];var{page:t=1,filter:a="default",key:s,site:o="stackoverflow"}=t;const n=new URLSearchParams({filter:a,key:s,pagesize:"100",site:o}),i=new URL(`${API_BASE}/${API_VER}/tags/${e.join(";")}/info`);return i.search=n.toString(),getPaginatedItems(i,t)},getQuestions=async(e,t)=>{if(!e.length)return[];var{page:t=1,filter:a="default",key:s,site:o="stackoverflow"}=t;const n=new URLSearchParams({filter:a,key:s,pagesize:"100",site:o}),i=new URL(`${API_BASE}/${API_VER}/questions/`+e.join(";"));return i.search=n.toString(),getPaginatedItems(i,t)},getAPIsite=()=>{const e=location["hostname"];return e.substring(0,e.lastIndexOf("."))},getPostGuid=async(e,t,a)=>{var s=new URL(t+`/posts/${a}/edit-inline`);const o=await fetch(s);if(o.ok){const n=document.createElement("html"),i=(n.innerHTML=await o.text(),n.querySelector("form.inline-post"));if(i)return i.action.replace(t+`/posts/${a}/edit-submit/`,"");console.debug(`[${e}] failed to parse post #${a} GUID`)}else console.debug(`[${e}] failed to get post #${a} GUID`)},submitEdit=async(t,e)=>{const{origin:a,postId:s,postGuid:o,comment:n,title:i,body:r,tags:d}=e;try{return 200===(await fetch(a+`/posts/${s}/edit-submit/`+o,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({"edit-comment":n,fkey:StackExchange.options.user.fkey,"is-current":"true","post-text":r,tagnames:d.join(" "),title:i})})).status}catch(e){return console.debug(`[${t}] failed to submit post #${s} edit`),!1}},sameTags=(e,t)=>e.length===t.size&&e.every(e=>t.has(e)),copyToClipboard=async(t,e)=>{try{var a="text/plain";return await navigator.clipboard.write([new ClipboardItem({"text/plain":new Blob([e],{type:a})})]),!0}catch(e){return console.debug(`[${t}] failed to copy to clipboard`,e),!1}},findRequestedTag=(e,t)=>{const[,a,...s]=/[\[`“]([\w.-]+)[\]`”]|tags?\s+for\s+["“]([\w.\s-]+)["`”]|(?:create|add|new)(?:\s+(?:a|the))?\s+tags?.+?[\[`"“]([\w.\s-]+)[\]`"”]/i.exec(e)||[],o=s.find(Boolean);var[,e]=/[\[`“](\w.-]+)[\]`”]/g.exec(t||"")||[];return null==(t=a||e||(null===o||void 0===o?void 0:o.replace(/\s+/g,"-")))?void 0:t.toLowerCase()},fixRequestTitle=(e,t)=>t?e.replace(/[\[`][\w.-]+[\]`]/i,`[${t}]`):e,scase=e=>e.slice(0,1).toUpperCase()+e.slice(1).toLowerCase(),handleFailureToGetPostFromAPI=(e,t)=>(console.debug(`[${e}] failed to get post #${t} from the API`),StackExchange.helpers.showToast("Failed to get post info from the API",{type:"danger"})),normalizeDatasetPropName=e=>e.split("-").map(([e,...t],a)=>""+(a?e.toUpperCase():e.toLowerCase())+t.join("").toLowerCase()).join(""),makeRequestStatusButton=(c,l,u)=>{const e=document.createElement("div"),t=(e.classList.add("flex--item"),document.createElement("button"));return t.classList.add("s-btn","s-btn__link"),t.dataset[normalizeDatasetPropName(c+"-btn")]=l,t.textContent=scase(l),t.title=scase(l)+" the tag creation request",t.type="button",t.addEventListener("click",async()=>{var[e]=await getQuestions([u],{filter:"7W_5I-T9o",key:API_KEY,site:getAPIsite()});if(!e)return handleFailureToGetPostFromAPI(c,u);var{body_markdown:e,link:t,tags:a=[],title:s}=e;if(!e||!s)return console.debug(`[${c}] missing post #${u} body/title`),StackExchange.helpers.showToast("Failed to get question body or title from the API",{type:"danger"});const o=new Set(a);StackExchange.options.user.isModerator&&o.add(`status-${l}d`),o.has("support")||o.has("discussion")||o.add("discussion"),o.delete("tag-creation-process"),o.delete("feature-request"),o.add("tags"),o.add("tag-creation-request");if(5<o.size)return console.debug(`[${c}] updated post has too many tags`),StackExchange.helpers.showToast("Posts can't have more than 5 tags",{type:"warning"});const n=[];sameTags(a,o)||n.push("retagged correctly");var a=location["origin"],i=await getPostGuid(c,a,u);if(!i)return console.debug(`[${c}] failed to get post #${u} GUID`),StackExchange.helpers.showToast("Failed to get the post GUID",{type:"danger"});var r=findRequestedTag(s,e);const d=fixRequestTitle(s,r);d!==s&&n.push("highlighted the tag in the title");s=`[tag:${r||""}] ${l} ([${d.replace(/(\[|\])/g,"\\$1")}](${t}))`;if(await copyToClipboard(c,s),StackExchange.helpers.showToast("Copied chat link to clipboard",{type:"info"}),!n.length)return console.debug(`[${c}] nothing to update in the post #`+u),StackExchange.helpers.showToast("Nothing would be updated in the post, aborting edit",{type:"info"});r=await submitEdit(c,{body:e,comment:n.join("; "),origin:a,postGuid:i,postId:u,tags:[...o],title:d});StackExchange.helpers.showToast(r?scase(l)+"d the request":`Failed to ${l} the request`,{type:r?"success":"danger"}),r&&(await wait(1e3),location.reload())}),e.append(t),[e,t]},addScriptStyles=e=>{var t=document.createElement("style");document.head.append(t);const a=t["sheet"];a?[`.s-btn[disabled][data-${e}-btn] {
            pointer-events: unset;
        }`].forEach(e=>a.insertRule(e)):console.debug(`[${e}] failed to add userscript styles`)};window.addEventListener("load",async()=>{var e="tag-creation-request-completer";addScriptStyles(e);for(const r of document.querySelectorAll(".js-question .js-post-menu > div:first-child")){var t=((null==(t=r.closest(".js-post-menu"))?void 0:t.dataset)||{})["postId"];if(!t)return void console.debug(`[${e}] missing question id`,r);const d=getAPIsite();var[a]=await getQuestions([t],{filter:"7W_5I-T9o",key:API_KEY,site:d}),[s,o]=(a||handleFailureToGetPostFromAPI(e,t),makeRequestStatusButton(e,"complete",t)),[t,n]=makeRequestStatusButton(e,"decline",t);if(a){var{body_markdown:a,title:i}=a,i=findRequestedTag(i,a);if(console.debug(`[${e}] request tag name: `+(i||"not found")),i){a=(await getTags([i],{key:API_KEY,site:d.replace("meta.","")}))["length"];const c=a?n:o;c.disabled=!0,c.title+=` (requested tag ${a?"":"not "}found)`}}r.append(s,t)}},{once:!0});